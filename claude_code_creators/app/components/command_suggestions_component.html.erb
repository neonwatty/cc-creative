<% if error_state? %>
  <div class="command-suggestions-dropdown error-state absolute z-50 max-w-sm bg-white border border-red-300 rounded-lg shadow-lg p-4"
       style="<%= dropdown_style %>"
       data-controller="command-suggestions"
       data-command-suggestions-target="dropdown">
    <div class="flex items-center text-red-600">
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
      </svg>
      <span class="text-sm font-medium">No document context</span>
    </div>
  </div>
<% elsif permission_error? %>
  <div class="command-suggestions-dropdown permission-error absolute z-50 max-w-sm bg-white border border-orange-300 rounded-lg shadow-lg p-4"
       style="<%= dropdown_style %>"
       data-controller="command-suggestions"
       data-command-suggestions-target="dropdown">
    <div class="flex items-center text-orange-600">
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 0h12a2 2 0 002-2v-9a2 2 0 00-2-2H6a2 2 0 00-2 2v9a2 2 0 002 2z"></path>
      </svg>
      <span class="text-sm font-medium">Access denied</span>
    </div>
  </div>
<% elsif show_empty_state? %>
  <div class="command-suggestions-dropdown empty-state absolute z-50 max-w-sm bg-white border border-gray-200 rounded-lg shadow-lg p-4"
       style="<%= dropdown_style %>"
       data-controller="command-suggestions"
       data-command-suggestions-target="dropdown">
    <div class="flex items-center text-gray-500">
      <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <span class="text-sm">No commands found</span>
    </div>
  </div>
<% else %>
  <div class="<%= dropdown_classes %> absolute z-50 bg-white border border-gray-200 rounded-lg shadow-xl max-w-md min-w-80 max-h-96 overflow-hidden"
       style="<%= dropdown_style %>"
       data-controller="command-suggestions"
       data-command-suggestions-target="dropdown"
       data-command-suggestions-document-id-value="<%= document&.id %>"
       role="listbox"
       aria-label="Available slash commands"
       aria-live="polite">
    
    <!-- Header -->
    <div class="px-4 py-3 border-b border-gray-100 bg-gray-50 rounded-t-lg">
      <h3 class="text-sm font-semibold text-gray-900 flex items-center">
        <svg class="h-4 w-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
        </svg>
        Commands
      </h3>
      <% if filter.present? %>
        <p class="text-xs text-gray-600 mt-1">Filtered by: "<%= filter %>"</p>
      <% end %>
    </div>

    <!-- Commands List -->
    <div class="command-list max-h-80 overflow-y-auto">
      <% filtered_commands.each_with_index do |command_info, index| %>
        <div class="<%= command_item_classes(index) %> px-4 py-3 border-b border-gray-50 hover:bg-blue-50 cursor-pointer transition-colors duration-150"
             id="<%= command_option_id(index) %>"
             aria-describedby="<%= command_description_id(index) %>"
             data-action="click->command-suggestions#selectCommand mouseenter->command-suggestions#highlightCommand mouseleave->command-suggestions#unhighlightCommand"
             data-command="<%= command_info[:command] %>"
             role="option"
             tabindex="-1"
             aria-selected="<%= index == selected_index ? 'true' : 'false' %>">
          
          <div class="flex items-start space-x-3">
            <!-- Command Icon -->
            <div class="flex-shrink-0 mt-0.5">
              <div class="command-icon <%= command_info[:icon] %> w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                <% case command_info[:command] %>
                <% when "save" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                  </svg>
                <% when "load" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                  </svg>
                <% when "compact" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                  </svg>
                <% when "clear" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                <% when "include" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                <% when "snippet" %>
                  <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                <% end %>
              </div>
            </div>

            <!-- Command Details -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <!-- Command Name and Parameters -->
                <div class="flex items-baseline space-x-2">
                  <span class="command-name text-sm font-semibold text-gray-900">/<%= command_info[:command] %></span>
                  <% if command_info[:parameters].any? %>
                    <span class="command-parameters text-xs text-gray-500 font-mono">
                      <%= format_parameter_display(command_info[:parameters]) %>
                    </span>
                    <% command_info[:parameters].each do |param| %>
                      <span class="<%= parameter_classes(param) %> hidden"></span>
                    <% end %>
                  <% end %>
                </div>

                <!-- Category Badge -->
                <span class="<%= category_classes(command_info[:category]) %> inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  <%= command_info[:category] %>
                </span>
              </div>

              <!-- Command Description -->
              <p class="command-description text-sm text-gray-600 mt-1" id="<%= command_description_id(index) %>">
                <%= command_info[:description] %>
              </p>

              <!-- Context Hints -->
              <% context_hints = context_hints_for_command(command_info[:command]) %>
              <% if context_hints.any? %>
                <div class="mt-2 space-y-1">
                  <% case command_info[:command] %>
                  <% when "load" %>
                    <div class="context-hint flex items-center text-xs text-blue-600">
                      <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      Available: <%= context_hints.join(", ") %>
                    </div>
                  <% when "include" %>
                    <div class="file-hint flex items-center text-xs text-green-600">
                      <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      Files: <%= context_hints.join(", ") %>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- Context Status for Context Commands -->
              <% if command_has_context_status?(command_info[:command]) %>
                <div class="context-available mt-2 flex items-center text-xs text-green-600">
                  <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Context available
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Footer -->
    <div class="px-4 py-3 border-t border-gray-100 bg-gray-50 rounded-b-lg">
      <div class="flex items-center justify-between text-xs text-gray-500">
        <span><%= filtered_commands.length %> command<%= "s" if filtered_commands.length != 1 %> available</span>
        <div class="flex items-center space-x-4">
          <span class="flex items-center">
            <kbd class="inline-flex items-center px-1.5 py-0.5 border border-gray-200 rounded text-xs font-mono">↑↓</kbd>
            <span class="ml-1">Navigate</span>
          </span>
          <span class="flex items-center">
            <kbd class="inline-flex items-center px-1.5 py-0.5 border border-gray-200 rounded text-xs font-mono">⏎</kbd>
            <span class="ml-1">Select</span>
          </span>
          <span class="flex items-center">
            <kbd class="inline-flex items-center px-1.5 py-0.5 border border-gray-200 rounded text-xs font-mono">⌘⏎</kbd>
            <span class="ml-1">Execute</span>
          </span>
        </div>
      </div>
    </div>

    <!-- Screen Reader Announcements -->
    <div class="sr-only" aria-live="polite">
      <% if filter.present? %>
        Showing <%= filtered_commands.length %> commands matching "<%= filter %>"
      <% else %>
        Showing all <%= filtered_commands.length %> available commands
      <% end %>
    </div>
  </div>
<% end %>

